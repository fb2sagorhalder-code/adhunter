<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AdHunter ‚Äî Google Ads Sales Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #ff6b35;
    --accent2: #ffd23f;
    --green: #2ecc71;
    --blue: #4a9eff;
    --text: #e8e8f0;
    --muted: #6b6b85;
    --danger: #ff4757;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(255,107,53,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,107,53,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Glow orb */
  body::after {
    content: '';
    position: fixed;
    top: -200px;
    right: -200px;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(255,107,53,0.08) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ===== HEADER ===== */
  header {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(10px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--accent); }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* ===== LAYOUT ===== */
  .app {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 260px 1fr 340px;
    height: calc(100vh - 65px);
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    border-right: 1px solid var(--border);
    padding: 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow-y: auto;
  }

  .sidebar-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 12px 12px 6px;
    margin-top: 8px;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--muted);
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    transition: all 0.15s;
  }

  .nav-btn:hover { background: var(--surface2); color: var(--text); }
  .nav-btn.active { background: rgba(255,107,53,0.12); color: var(--accent); border: 1px solid rgba(255,107,53,0.2); }

  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  .badge {
    margin-left: auto;
    background: var(--accent);
    color: #000;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 20px;
  }

  .badge.green { background: var(--green); }
  .badge.blue { background: var(--blue); }

  /* Stats in sidebar */
  .sidebar-stats {
    margin-top: auto;
    padding: 16px;
    background: var(--surface2);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 12px;
    border-bottom: 1px solid var(--border);
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-label { color: var(--muted); }
  .stat-val { color: var(--text); font-weight: 500; }
  .stat-val.accent { color: var(--accent); }
  .stat-val.green { color: var(--green); }

  /* ===== MAIN CONTENT ===== */
  .main {
    overflow-y: auto;
    padding: 28px 28px;
  }

  .page { display: none; }
  .page.active { display: block; }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .page-sub {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 24px;
    letter-spacing: 0.5px;
  }

  /* ===== LEAD INPUT FORM ===== */
  .input-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 20px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .field.full { grid-column: span 2; }

  label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  input, select, textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    transition: border 0.2s;
    outline: none;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
  }

  select option { background: var(--surface2); }

  textarea { resize: vertical; min-height: 80px; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 11px 22px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }
  .btn-primary:hover { background: #ff8555; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,107,53,0.3); }

  .btn-ghost {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .btn-sm { padding: 7px 14px; font-size: 12px; }

  /* ===== LEAD CARDS ===== */
  .leads-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .lead-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .lead-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--muted);
    transition: background 0.2s;
  }

  .lead-card.new::before { background: var(--blue); }
  .lead-card.contacted::before { background: var(--accent2); }
  .lead-card.qualified::before { background: var(--accent); }
  .lead-card.converted::before { background: var(--green); }
  .lead-card.lost::before { background: var(--danger); }

  .lead-card:hover { border-color: var(--accent); background: var(--surface2); }
  .lead-card.selected { border-color: var(--accent); background: var(--surface2); box-shadow: 0 0 0 1px var(--accent); }

  .lead-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .lead-name {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
  }

  .lead-location {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
  }

  .stage-badge {
    font-size: 10px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .stage-new { background: rgba(74,158,255,0.15); color: var(--blue); border: 1px solid rgba(74,158,255,0.3); }
  .stage-contacted { background: rgba(255,210,63,0.15); color: var(--accent2); border: 1px solid rgba(255,210,63,0.3); }
  .stage-qualified { background: rgba(255,107,53,0.15); color: var(--accent); border: 1px solid rgba(255,107,53,0.3); }
  .stage-converted { background: rgba(46,204,113,0.15); color: var(--green); border: 1px solid rgba(46,204,113,0.3); }
  .stage-lost { background: rgba(255,71,87,0.15); color: var(--danger); border: 1px solid rgba(255,71,87,0.3); }

  .lead-meta {
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: var(--muted);
  }

  .lead-meta span { display: flex; align-items: center; gap: 4px; }

  /* ===== RIGHT PANEL ===== */
  .right-panel {
    border-left: 1px solid var(--border);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .panel-header {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: -0.2px;
  }

  .panel-body { padding: 20px; flex: 1; }

  .ai-section {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .ai-section-header {
    padding: 10px 14px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,107,53,0.04);
  }

  .ai-section-body {
    padding: 14px;
    font-size: 13px;
    line-height: 1.7;
    color: var(--text);
    white-space: pre-wrap;
  }

  .score-bar {
    height: 6px;
    background: var(--surface);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 6px;
  }
  .score-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 1s ease;
  }

  .score-label {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .action-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 14px 20px;
    border-top: 1px solid var(--border);
  }

  /* ===== PIPELINE PAGE ===== */
  .pipeline-columns {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    align-items: start;
  }

  .pipeline-col {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .pipeline-col-header {
    padding: 12px 14px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
  }

  .pipeline-col-header.new { color: var(--blue); }
  .pipeline-col-header.contacted { color: var(--accent2); }
  .pipeline-col-header.qualified { color: var(--accent); }
  .pipeline-col-header.converted { color: var(--green); }
  .pipeline-col-header.lost { color: var(--danger); }

  .pipeline-items { padding: 10px; display: flex; flex-direction: column; gap: 8px; }

  .pipeline-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .pipeline-item:hover { border-color: var(--accent); }
  .pipeline-item-name { font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .pipeline-item-meta { color: var(--muted); font-size: 11px; }

  /* ===== AI OUTREACH ===== */
  .outreach-form { display: flex; flex-direction: column; gap: 16px; }

  .pitch-output {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    font-size: 13px;
    line-height: 1.8;
    min-height: 200px;
    white-space: pre-wrap;
    color: var(--text);
    position: relative;
  }

  .typing-cursor::after {
    content: '‚ñå';
    animation: blink 0.7s infinite;
    color: var(--accent);
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ===== FOLLOW UP ===== */
  .followup-list { display: flex; flex-direction: column; gap: 10px; }

  .followup-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .followup-date {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    text-align: center;
    min-width: 52px;
  }
  .followup-date .day { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--accent); line-height: 1; }
  .followup-date .month { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }

  .followup-info { flex: 1; }
  .followup-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .followup-note { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* ===== EMPTY STATE ===== */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--accent);
    color: var(--text);
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    z-index: 100;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    box-shadow: 0 4px 24px rgba(255,107,53,0.2);
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 50;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    max-width: 560px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
  }

  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .lead-card { animation: fadeIn 0.3s ease; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">Ad<span>Hunter</span></div>
  <div class="header-meta">
    <div class="status-dot" id="api-dot" style="background:var(--danger);box-shadow:0 0 8px var(--danger);"></div>
    <span id="api-status-text" style="color:var(--danger);">NO API KEY</span>
    <span style="color: var(--border)">|</span>
    <span>üá¶üá∫ AUSTRALIA</span>
    <span style="color: var(--border)">|</span>
    <span>HOME REMODELING NICHE</span>
    <span style="color: var(--border)">|</span>
    <button onclick="openApiModal()" id="api-btn" style="background:rgba(255,71,87,0.15);border:1px solid rgba(255,71,87,0.5);color:var(--danger);padding:5px 14px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.5px;">‚öôÔ∏è SET API KEY</button>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-label">Navigation</div>
    <button class="nav-btn active" onclick="showPage('leads')" id="nav-leads">
      <span class="nav-icon">üéØ</span> Lead Hunt
      <span class="badge blue" id="badge-new">0</span>
    </button>
    <button class="nav-btn" onclick="showPage('pipeline')" id="nav-pipeline">
      <span class="nav-icon">üìä</span> Pipeline
    </button>
    <button class="nav-btn" onclick="showPage('outreach')" id="nav-outreach">
      <span class="nav-icon">‚úâÔ∏è</span> AI Outreach
    </button>
    <button class="nav-btn" onclick="showPage('followup')" id="nav-followup">
      <span class="nav-icon">üîî</span> Follow-ups
      <span class="badge" id="badge-followup">0</span>
    </button>

    <div class="divider" style="margin: 12px 0;"></div>

    <div class="sidebar-stats">
      <div class="stat-row">
        <span class="stat-label">Total Leads</span>
        <span class="stat-val" id="stat-total">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Contacted</span>
        <span class="stat-val" id="stat-contacted">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Qualified</span>
        <span class="stat-val" id="stat-qualified">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Converted</span>
        <span class="stat-val green" id="stat-converted">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Conv. Rate</span>
        <span class="stat-val accent" id="stat-rate">0%</span>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main">

    <!-- LEADS PAGE -->
    <div class="page active" id="page-leads">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 24px;">
        <div>
          <div class="page-title">Lead Hunt üéØ</div>
          <div class="page-sub">Manually add leads & let AI qualify them instantly</div>
        </div>
        <button class="btn btn-primary" onclick="openAddLead()">+ Add Lead</button>
      </div>

      <!-- Filter bar -->
      <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="filterLeads('all')" id="f-all" style="border-color:var(--accent); color:var(--accent);">All</button>
        <button class="btn btn-ghost btn-sm" onclick="filterLeads('new')" id="f-new">New</button>
        <button class="btn btn-ghost btn-sm" onclick="filterLeads('contacted')" id="f-contacted">Contacted</button>
        <button class="btn btn-ghost btn-sm" onclick="filterLeads('qualified')" id="f-qualified">Qualified</button>
        <button class="btn btn-ghost btn-sm" onclick="filterLeads('converted')" id="f-converted">Converted</button>
      </div>

      <div class="leads-grid" id="leads-list">
        <div class="empty">
          <div class="empty-icon">üîç</div>
          <div class="empty-text">No leads yet. Add your first lead to get started.</div>
        </div>
      </div>
    </div>

    <!-- PIPELINE PAGE -->
    <div class="page" id="page-pipeline">
      <div class="page-title">Pipeline üìä</div>
      <div class="page-sub">Track every lead through your sales funnel</div>
      <div class="pipeline-columns" id="pipeline-board">
        <!-- Rendered by JS -->
      </div>
    </div>

    <!-- OUTREACH PAGE -->
    <div class="page" id="page-outreach">
      <div class="page-title">AI Outreach ‚úâÔ∏è</div>
      <div class="page-sub">Generate personalized cold outreach messages powered by AI</div>

      <div class="outreach-form">
        <div class="input-grid">
          <div class="field">
            <label>Business Name</label>
            <input type="text" id="out-biz" placeholder="e.g. Sydney Kitchen Renovations">
          </div>
          <div class="field">
            <label>Location</label>
            <input type="text" id="out-loc" placeholder="e.g. Sydney, NSW">
          </div>
          <div class="field">
            <label>Service Type</label>
            <select id="out-service">
              <option>Kitchen Renovation</option>
              <option>Bathroom Remodel</option>
              <option>Home Extension</option>
              <option>Full Home Renovation</option>
              <option>Deck/Outdoor</option>
              <option>Roofing</option>
              <option>General Remodeling</option>
            </select>
          </div>
          <div class="field">
            <label>Message Type</label>
            <select id="out-type">
              <option>Cold Email</option>
              <option>LinkedIn DM</option>
              <option>SMS</option>
              <option>Follow-up Email</option>
            </select>
          </div>
          <div class="field full">
            <label>Extra Notes (optional)</label>
            <input type="text" id="out-notes" placeholder="e.g. No Google Ads running, 4.8 star reviews, busy in summer">
          </div>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-primary" onclick="generateOutreach()">‚ö° Generate with AI</button>
          <button class="btn btn-ghost" onclick="copyOutreach()">üìã Copy</button>
        </div>

        <div id="out-loading" style="display:none; font-size:13px; color:var(--muted); padding:8px 0;">
          ü§ñ AI is writing your pitch...
        </div>

        <div class="pitch-output" id="pitch-output" style="display:none;"></div>
      </div>
    </div>

    <!-- FOLLOWUP PAGE -->
    <div class="page" id="page-followup">
      <div class="page-title">Follow-ups üîî</div>
      <div class="page-sub">Never miss a follow-up with a lead</div>
      <div class="followup-list" id="followup-list">
        <div class="empty">
          <div class="empty-icon">üìÖ</div>
          <div class="empty-text">No follow-ups scheduled yet.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel" id="right-panel">
    <div class="panel-header">Lead Details</div>
    <div class="panel-body">
      <div class="empty" style="padding: 40px 10px;">
        <div class="empty-icon">üëà</div>
        <div class="empty-text" style="font-size:13px;">Select a lead to see AI analysis & actions</div>
      </div>
    </div>
  </div>
</div>

<!-- ADD LEAD MODAL -->
<div class="modal-overlay" id="modal-add">
  <div class="modal">
    <div class="modal-title">+ Add New Lead</div>

    <!-- WEBSITE SCAN SECTION -->
    <div style="background:rgba(255,107,53,0.06); border:1px solid rgba(255,107,53,0.2); border-radius:10px; padding:14px; margin-bottom:18px;">
      <div style="font-size:11px; color:var(--muted); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:10px;">‚ö° AI Website Scanner ‚Äî Auto-fill everything</div>
      <div style="display:flex; gap:8px;">
        <input type="text" id="scan-url" placeholder="https://www.example.com.au" style="flex:1; font-size:13px;">
        <button class="btn btn-primary btn-sm" onclick="scanWebsite()" id="scan-btn">üîç Scan</button>
      </div>
      <div id="scan-status" style="margin-top:10px; font-size:12px; display:none;"></div>
      <div id="scan-result" style="margin-top:10px; font-size:12px; color:var(--green); display:none;"></div>
    </div>

    <div style="font-size:11px; color:var(--muted); letter-spacing:1px; margin-bottom:14px; text-align:center;">‚Äî OR fill manually ‚Äî</div>

    <div class="input-grid">
      <div class="field">
        <label>Business Name *</label>
        <input type="text" id="add-name" placeholder="e.g. Melbourne Home Reno Co.">
      </div>
      <div class="field">
        <label>Owner Name</label>
        <input type="text" id="add-owner" placeholder="e.g. James Smith">
      </div>
      <div class="field">
        <label>City / State *</label>
        <input type="text" id="add-city" placeholder="e.g. Melbourne, VIC">
      </div>
      <div class="field">
        <label>Phone</label>
        <input type="text" id="add-phone" placeholder="+61 4XX XXX XXX">
      </div>
      <div class="field">
        <label>Email</label>
        <input type="text" id="add-email" placeholder="info@example.com.au">
      </div>
      <div class="field">
        <label>Website</label>
        <input type="text" id="add-web" placeholder="www.example.com.au">
      </div>
      <div class="field">
        <label>Service</label>
        <select id="add-service">
          <option>Kitchen Renovation</option>
          <option>Bathroom Remodel</option>
          <option>Home Extension</option>
          <option>Full Home Renovation</option>
          <option>Deck/Outdoor</option>
          <option>Roofing</option>
          <option>General Remodeling</option>
        </select>
      </div>
      <div class="field">
        <label>Currently Running Google Ads?</label>
        <select id="add-ads">
          <option value="no">No</option>
          <option value="yes-poor">Yes, but poorly</option>
          <option value="yes-good">Yes, doing well</option>
          <option value="unknown">Unknown</option>
        </select>
      </div>
      <div class="field full">
        <label>Notes</label>
        <textarea id="add-notes" placeholder="Any info: reviews, company size, website quality, seasonal timing..."></textarea>
      </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:8px;">
      <button class="btn btn-primary" onclick="addLead()">Add & Qualify</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>


<!-- API KEY MODAL -->
<div class="modal-overlay" id="modal-api">
  <div class="modal" style="max-width:480px;">
    <div class="modal-title">‚öôÔ∏è Anthropic API Key</div>
    <p style="font-size:13px; color:var(--muted); margin-bottom:18px; line-height:1.7;">
      ‡¶è‡¶á app ‡¶ü‡¶ø locally browser-‡¶è run ‡¶ï‡¶∞‡¶§‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Anthropic API key ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡•§<br>
      Key ‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ browser-‡¶è save ‡¶π‡¶¨‡ßá ‚Äî ‡¶ï‡ßã‡¶•‡¶æ‡¶ì ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§
    </p>
    <div style="background:rgba(255,107,53,0.06); border:1px solid rgba(255,107,53,0.2); border-radius:8px; padding:12px; margin-bottom:16px; font-size:12px; color:var(--muted);">
      üìå API key ‡¶™‡¶æ‡¶¨‡ßá: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent); text-decoration:none;">console.anthropic.com/settings/keys</a>
    </div>
    <div class="field" style="margin-bottom:16px;">
      <label>API Key</label>
      <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." style="font-size:13px; letter-spacing:1px;">
    </div>
    <div id="api-test-status" style="font-size:12px; margin-bottom:12px; display:none;"></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="saveApiKey()">üíæ Save & Test</button>
      <button class="btn btn-ghost" onclick="closeApiModal()">Cancel</button>
      <button class="btn btn-ghost btn-sm" onclick="clearApiKey()" style="margin-left:auto; color:var(--danger); border-color:var(--danger);">üóëÔ∏è Clear</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let leads = JSON.parse(localStorage.getItem('adhunter_leads') || '[]');
let selectedLead = null;
let currentFilter = 'all';
let ANTHROPIC_API_KEY = localStorage.getItem('adhunter_api_key') || '';

// ===== API KEY FUNCTIONS =====
function openApiModal() {
  document.getElementById('modal-api').classList.add('open');
  if (ANTHROPIC_API_KEY) document.getElementById('api-key-input').value = ANTHROPIC_API_KEY;
  document.getElementById('api-test-status').style.display = 'none';
}

function closeApiModal() {
  document.getElementById('modal-api').classList.remove('open');
}

function clearApiKey() {
  ANTHROPIC_API_KEY = '';
  localStorage.removeItem('adhunter_api_key');
  document.getElementById('api-key-input').value = '';
  updateApiStatus();
  closeApiModal();
  showToast('üóëÔ∏è API key removed');
}

async function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key || !key.startsWith('sk-ant-')) {
    document.getElementById('api-test-status').style.display = 'block';
    document.getElementById('api-test-status').style.color = 'var(--danger)';
    document.getElementById('api-test-status').textContent = '‚ö†Ô∏è Invalid key format. Should start with sk-ant-...';
    return;
  }

  const statusEl = document.getElementById('api-test-status');
  statusEl.style.display = 'block';
  statusEl.style.color = 'var(--accent2)';
  statusEl.textContent = '‚è≥ Testing API key...';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 10, messages: [{ role: 'user', content: 'Hi' }] })
    });
    if (res.ok || res.status === 200) {
      ANTHROPIC_API_KEY = key;
      localStorage.setItem('adhunter_api_key', key);
      statusEl.style.color = 'var(--green)';
      statusEl.textContent = '‚úÖ API key valid! Saving...';
      updateApiStatus();
      setTimeout(() => closeApiModal(), 1200);
    } else {
      const err = await res.json();
      statusEl.style.color = 'var(--danger)';
      statusEl.textContent = '‚ùå Invalid key: ' + (err.error?.message || 'Authentication failed');
    }
  } catch(e) {
    // If CORS error still happens, just save it anyway
    ANTHROPIC_API_KEY = key;
    localStorage.setItem('adhunter_api_key', key);
    statusEl.style.color = 'var(--green)';
    statusEl.textContent = '‚úÖ Key saved! (Could not verify ‚Äî will test on first use)';
    updateApiStatus();
    setTimeout(() => closeApiModal(), 1500);
  }
}

function updateApiStatus() {
  const dot = document.getElementById('api-dot');
  const text = document.getElementById('api-status-text');
  const btn = document.getElementById('api-btn');
  if (ANTHROPIC_API_KEY) {
    dot.style.background = 'var(--green)';
    dot.style.boxShadow = '0 0 8px var(--green)';
    dot.style.animation = 'pulse 2s infinite';
    text.style.color = 'var(--green)';
    text.textContent = 'AGENT ACTIVE';
    btn.style.background = 'rgba(46,204,113,0.1)';
    btn.style.borderColor = 'rgba(46,204,113,0.3)';
    btn.style.color = 'var(--green)';
    btn.textContent = '‚úÖ API KEY SET';
  } else {
    dot.style.background = 'var(--danger)';
    dot.style.boxShadow = '0 0 8px var(--danger)';
    text.style.color = 'var(--danger)';
    text.textContent = 'NO API KEY';
    btn.style.background = 'rgba(255,71,87,0.15)';
    btn.style.borderColor = 'rgba(255,71,87,0.5)';
    btn.style.color = 'var(--danger)';
    btn.textContent = '‚öôÔ∏è SET API KEY';
  }
}

// ===== NAVIGATION =====
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'pipeline') renderPipeline();
  if (name === 'followup') renderFollowups();
}

// ===== MODAL =====
function openAddLead() {
  document.getElementById('modal-add').classList.add('open');
}
function closeModal() {
  document.getElementById('modal-add').classList.remove('open');
  ['add-name','add-owner','add-city','add-phone','add-email','add-web','add-notes','scan-url'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('scan-status').style.display = 'none';
  document.getElementById('scan-result').style.display = 'none';
  document.getElementById('scan-btn').disabled = false;
  document.getElementById('scan-btn').textContent = 'üîç Scan';
}

// ===== WEBSITE SCANNER =====
async function scanWebsite() {
  let url = document.getElementById('scan-url').value.trim();
  if (!url) { showToast('‚ö†Ô∏è Enter a website URL first'); return; }
  if (!url.startsWith('http')) url = 'https://' + url;

  const statusEl = document.getElementById('scan-status');
  const resultEl = document.getElementById('scan-result');
  const btn = document.getElementById('scan-btn');

  statusEl.style.display = 'block';
  resultEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = '‚è≥ Scanning...';
  statusEl.style.color = 'var(--accent2)';

  const steps = ['üåê Connecting to AI...', 'üîç Analyzing website...', 'üìã Extracting info...', '‚úÖ Almost done...'];
  let stepIdx = 0;
  statusEl.textContent = steps[0];
  const stepInterval = setInterval(() => {
    if (stepIdx < steps.length - 1) statusEl.textContent = steps[++stepIdx];
  }, 1500);

  try {
    const prompt = `You are a Google Ads sales expert analyzing an Australian home renovation business website.

Visit and analyze this website: ${url}

Based on the URL and any information you can infer about this business, respond in this EXACT JSON format only (no extra text):
{
  "businessName": "business name from the URL/domain or inferred",
  "ownerName": "",
  "city": "Australian city and state if detectable, else 'Australia'",
  "phone": "",
  "email": "",
  "service": "one of: Kitchen Renovation, Bathroom Remodel, Home Extension, Full Home Renovation, Deck/Outdoor, Roofing, General Remodeling",
  "adsDetected": "unknown",
  "websiteQuality": "average",
  "notes": "Based on the URL ${url} ‚Äî describe what type of renovation business this likely is and why they would benefit from Google Ads",
  "adsPotential": "high",
  "keyInsight": "specific reason why this business needs Google Ads right now"
}

Use the web_search tool to actually visit ${url} and extract real information before responding.`;

    const aiRes = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        tools: [{ type: "web_search_20250305", name: "web_search" }],
        messages: [{ role: "user", content: `Visit this website and extract business information as JSON: ${url}\n\nSearch for "${url}" and also try to fetch the page. Then respond with ONLY this JSON (no other text):\n{\n  "businessName": "exact name from site",\n  "ownerName": "owner if found else empty",\n  "city": "city, STATE",\n  "phone": "phone if found else empty",\n  "email": "email if found else empty",\n  "service": "Kitchen Renovation OR Bathroom Remodel OR Home Extension OR Full Home Renovation OR Deck/Outdoor OR Roofing OR General Remodeling",\n  "adsDetected": "no OR unknown",\n  "websiteQuality": "poor OR average OR good",\n  "notes": "2-3 sentences about the business and Google Ads opportunity",\n  "adsPotential": "high OR medium OR low",\n  "keyInsight": "one sharp reason they need Google Ads"\n}` }]
      })
    });

    const aiData = await aiRes.json();
    const rawText = aiData.content?.filter(c => c.type === 'text').map(c => c.text || '').join('') || '';

    clearInterval(stepInterval);

    let info;
    try {
      const jsonMatch = rawText.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('No JSON found');
      info = JSON.parse(jsonMatch[0]);
    } catch(e) {
      // Fallback: extract from URL
      const domain = url.replace(/https?:\/\/(www\.)?/, '').split('/')[0].split('.')[0];
      const bizName = domain.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      info = {
        businessName: bizName,
        ownerName: '', city: 'Australia',
        phone: '', email: '',
        service: 'General Remodeling',
        adsDetected: 'unknown',
        websiteQuality: 'average',
        notes: `Business found at ${url}. Home renovation company that could benefit from Google Ads to attract high-intent local customers.`,
        adsPotential: 'high',
        keyInsight: 'Home renovation leads from Google Ads have 5-10x higher intent than organic traffic.'
      };
    }

    statusEl.style.display = 'none';

    // Auto-fill form
    if (info.businessName) document.getElementById('add-name').value = info.businessName;
    if (info.ownerName) document.getElementById('add-owner').value = info.ownerName;
    if (info.city) document.getElementById('add-city').value = info.city;
    if (info.phone) document.getElementById('add-phone').value = info.phone;
    if (info.email) document.getElementById('add-email').value = info.email;
    document.getElementById('add-web').value = url;

    const sel = document.getElementById('add-service');
    for (let opt of sel.options) {
      if (opt.value === info.service) { sel.value = info.service; break; }
    }
    if (info.adsDetected === 'no') document.getElementById('add-ads').value = 'no';

    const notesText = [
      info.notes || '',
      info.keyInsight ? `üí° ${info.keyInsight}` : '',
      info.websiteQuality ? `Website quality: ${info.websiteQuality}` : '',
      info.adsPotential ? `Ads potential: ${info.adsPotential}` : ''
    ].filter(Boolean).join('\n');
    document.getElementById('add-notes').value = notesText;

    resultEl.style.color = 'var(--green)';
    resultEl.style.display = 'block';
    resultEl.innerHTML = `‚úÖ Done! Found: <strong>${info.businessName}</strong> ¬∑ ${info.city} ¬∑ Ads potential: <strong style="color:${info.adsPotential==='high'?'var(--green)':'var(--accent2)'}">${info.adsPotential}</strong>`;

  } catch(e) {
    clearInterval(stepInterval);
    statusEl.style.display = 'none';
    resultEl.style.display = 'block';
    resultEl.style.color = 'var(--accent2)';
    resultEl.textContent = '‚ö†Ô∏è Auto-fill failed ‚Äî please fill in manually below.';
  }

  btn.disabled = false;
  btn.textContent = 'üîç Scan';
}

// ===== ADD LEAD =====
function addLead() {
  const name = document.getElementById('add-name').value.trim();
  const city = document.getElementById('add-city').value.trim();
  if (!name || !city) { showToast('‚ö†Ô∏è Business name & city are required'); return; }

  const lead = {
    id: Date.now(),
    name,
    owner: document.getElementById('add-owner').value.trim(),
    city,
    phone: document.getElementById('add-phone').value.trim(),
    email: document.getElementById('add-email').value.trim(),
    website: document.getElementById('add-web').value.trim(),
    service: document.getElementById('add-service').value,
    ads: document.getElementById('add-ads').value,
    notes: document.getElementById('add-notes').value.trim(),
    stage: 'new',
    score: calcScore(document.getElementById('add-ads').value, document.getElementById('add-notes').value),
    addedAt: new Date().toISOString(),
    followupDate: null,
    history: [`Lead added ‚Äî ${new Date().toLocaleDateString('en-AU')}`]
  };

  leads.unshift(lead);
  save();
  closeModal();
  renderLeads();
  updateStats();
  selectLead(lead.id);
  showToast('‚úÖ Lead added & qualified!');
}

function calcScore(ads, notes) {
  let score = 40;
  if (ads === 'no') score += 35;
  else if (ads === 'yes-poor') score += 20;
  else if (ads === 'yes-good') score -= 10;
  else score += 15;

  const n = notes.toLowerCase();
  if (n.includes('no website') || n.includes('poor website')) score += 15;
  if (n.includes('review') || n.includes('star')) score += 10;
  if (n.includes('busy') || n.includes('growing')) score += 8;
  if (n.includes('small') || n.includes('local')) score += 5;
  return Math.min(99, Math.max(10, score));
}

// ===== RENDER LEADS =====
function renderLeads() {
  const list = document.getElementById('leads-list');
  const filtered = currentFilter === 'all' ? leads : leads.filter(l => l.stage === currentFilter);

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">No leads in this category yet.</div></div>`;
    return;
  }

  list.innerHTML = filtered.map(l => `
    <div class="lead-card ${l.stage} ${selectedLead?.id === l.id ? 'selected' : ''}" onclick="selectLead(${l.id})">
      <div class="lead-top">
        <div>
          <div class="lead-name">${l.name}</div>
          <div class="lead-location">üìç ${l.city} ¬∑ ${l.service}</div>
        </div>
        <span class="stage-badge stage-${l.stage}">${l.stage}</span>
      </div>
      <div class="lead-meta">
        <span>üéØ Score: <strong style="color:${scoreColor(l.score)}">${l.score}</strong></span>
        ${l.phone ? `<span>üìû ${l.phone}</span>` : ''}
        ${l.ads === 'no' ? '<span style="color:var(--green)">‚úì No Ads (Hot!)</span>' : ''}
        <span style="margin-left:auto; color: var(--muted);">${new Date(l.addedAt).toLocaleDateString('en-AU')}</span>
      </div>
    </div>
  `).join('');
}

function scoreColor(s) {
  if (s >= 75) return 'var(--green)';
  if (s >= 50) return 'var(--accent2)';
  return 'var(--accent)';
}

function filterLeads(f) {
  currentFilter = f;
  document.querySelectorAll('[id^="f-"]').forEach(b => {
    b.style.borderColor = '';
    b.style.color = '';
  });
  const btn = document.getElementById('f-' + f);
  if (btn) { btn.style.borderColor = 'var(--accent)'; btn.style.color = 'var(--accent)'; }
  renderLeads();
}

// ===== SELECT LEAD =====
function selectLead(id) {
  selectedLead = leads.find(l => l.id === id);
  if (!selectedLead) return;
  renderLeads();
  renderPanel();
}

function renderPanel() {
  const l = selectedLead;
  const adsLabel = { no: '‚ùå Not Running (Opportunity!)', 'yes-poor': '‚ö†Ô∏è Running Poorly', 'yes-good': '‚úÖ Running Well', unknown: '‚ùì Unknown' };

  const aiAnalysis = getAIAnalysis(l);
  const pitchPoints = getPitchPoints(l);

  document.getElementById('right-panel').innerHTML = `
    <div class="panel-header">
      ${l.name}
      <div style="font-size:11px; font-weight:400; color:var(--muted); margin-top:3px;">${l.city} ¬∑ ${l.service}</div>
    </div>
    <div class="panel-body">

      <!-- Score -->
      <div class="ai-section">
        <div class="ai-section-header">
          <span>AI LEAD SCORE</span>
          <span style="color:${scoreColor(l.score)}; font-size:14px; font-weight:700;">${l.score}/99</span>
        </div>
        <div style="padding:14px;">
          <div class="score-label"><span>Potential</span><span>${l.score >= 75 ? 'üî• Hot Lead' : l.score >= 50 ? 'üëç Warm Lead' : '‚ùÑÔ∏è Cold Lead'}</span></div>
          <div class="score-bar"><div class="score-fill" style="width:${l.score}%"></div></div>
        </div>
      </div>

      <!-- Contact Info -->
      <div class="ai-section">
        <div class="ai-section-header"><span>CONTACT INFO</span></div>
        <div class="ai-section-body" style="font-size:12px;">
${l.owner ? `üë§ ${l.owner}\n` : ''}üìç ${l.city}
${l.phone ? `üìû ${l.phone}\n` : ''}${l.email ? `üìß ${l.email}\n` : ''}${l.website ? `üåê ${l.website}\n` : ''}üéØ Google Ads: ${adsLabel[l.ads]}
        </div>
      </div>

      <!-- AI Analysis -->
      <div class="ai-section">
        <div class="ai-section-header"><span>AI ANALYSIS</span><span>ü§ñ</span></div>
        <div class="ai-section-body">${aiAnalysis}</div>
      </div>

      <!-- Pitch Points -->
      <div class="ai-section">
        <div class="ai-section-header"><span>PITCH ANGLES</span><span>üí°</span></div>
        <div class="ai-section-body">${pitchPoints}</div>
      </div>

      <!-- Stage -->
      <div class="ai-section">
        <div class="ai-section-header"><span>UPDATE STAGE</span></div>
        <div style="padding:10px; display:flex; flex-wrap:wrap; gap:6px;">
          ${['new','contacted','qualified','converted','lost'].map(s =>
            `<button class="btn btn-ghost btn-sm" onclick="updateStage(${l.id}, '${s}')" style="${l.stage===s ? 'border-color:var(--accent);color:var(--accent);' : ''}">${s}</button>`
          ).join('')}
        </div>
      </div>

      <!-- Follow-up -->
      <div class="ai-section">
        <div class="ai-section-header"><span>SCHEDULE FOLLOW-UP</span></div>
        <div style="padding:10px; display:flex; gap:8px;">
          <input type="date" id="fu-date" style="flex:1; font-size:12px; padding:8px 10px;">
          <button class="btn btn-ghost btn-sm" onclick="scheduleFollowup(${l.id})">Set</button>
        </div>
        ${l.followupDate ? `<div style="padding:0 14px 10px; font-size:12px; color:var(--green);">‚è∞ Scheduled: ${new Date(l.followupDate).toLocaleDateString('en-AU')}</div>` : ''}
      </div>

      <!-- Notes -->
      ${l.notes ? `<div class="ai-section">
        <div class="ai-section-header"><span>NOTES</span></div>
        <div class="ai-section-body" style="font-size:12px; color:var(--muted);">${l.notes}</div>
      </div>` : ''}

    </div>
    <div class="action-row">
      <button class="btn btn-primary btn-sm" onclick="quickOutreach(${l.id})">‚ö° Generate Pitch</button>
      <button class="btn btn-ghost btn-sm" onclick="deleteLead(${l.id})">üóëÔ∏è Delete</button>
    </div>
  `;
}

function getAIAnalysis(l) {
  const analyses = [];
  if (l.ads === 'no') analyses.push(`üéØ This business has NO Google Ads ‚Äî perfect opportunity. They're likely getting zero paid traffic while competitors dominate. Your pitch: "You're leaving money on the table every day."`);
  else if (l.ads === 'yes-poor') analyses.push(`‚ö†Ô∏è They're running Google Ads but poorly. This means wasted budget ‚Äî you can position yourself as the expert who'll fix their campaigns and stop the bleeding.`);
  else if (l.ads === 'yes-good') analyses.push(`‚úÖ Already running good ads. Harder to break in. Focus on proving you can scale beyond their current results.`);

  if (l.notes?.toLowerCase().includes('review') || l.notes?.toLowerCase().includes('star')) {
    analyses.push(`‚≠ê Good reviews indicate an established, quality business ‚Äî they CAN afford ads and have something worth promoting.`);
  }
  if (l.notes?.toLowerCase().includes('website')) {
    analyses.push(`üåê Website mentioned in notes ‚Äî reference their site quality in your pitch to show you've done your homework.`);
  }

  analyses.push(`üìç ${l.city} is a competitive renovation market. High average job value (AUD $15k‚Äì$80k) means even 1 new client/month pays for ads 10x over.`);

  return analyses.join('\n\n');
}

function getPitchPoints(l) {
  const points = [
    `‚Ä¢ "Your competitors in ${l.city} are running Google Ads right now ‚Äî are you showing up?"`,
    `‚Ä¢ "Home renovation leads from Google Ads have 5‚Äì10x higher intent than social media."`,
    `‚Ä¢ "Average AU renovation job: $25,000‚Äì$60,000. One lead from ads = entire monthly spend covered."`,
  ];
  if (l.ads === 'no') points.push(`‚Ä¢ "You've built a great business. Let's bring the customers to YOU ‚Äî not the other way around."`);
  return points.join('\n');
}

// ===== STAGE UPDATE =====
function updateStage(id, stage) {
  const l = leads.find(x => x.id === id);
  if (!l) return;
  l.stage = stage;
  l.history = l.history || [];
  l.history.push(`Stage ‚Üí ${stage} ‚Äî ${new Date().toLocaleDateString('en-AU')}`);
  save();
  renderLeads();
  renderPanel();
  updateStats();
  showToast(`‚úÖ Stage updated to: ${stage}`);
}

function scheduleFollowup(id) {
  const l = leads.find(x => x.id === id);
  const date = document.getElementById('fu-date').value;
  if (!l || !date) { showToast('‚ö†Ô∏è Pick a date first'); return; }
  l.followupDate = date;
  save();
  renderPanel();
  updateStats();
  showToast('üìÖ Follow-up scheduled!');
}

function deleteLead(id) {
  if (!confirm('Delete this lead?')) return;
  leads = leads.filter(l => l.id !== id);
  selectedLead = null;
  save();
  renderLeads();
  updateStats();
  document.getElementById('right-panel').innerHTML = `
    <div class="panel-header">Lead Details</div>
    <div class="panel-body"><div class="empty" style="padding:40px 10px;"><div class="empty-icon">üëà</div><div class="empty-text" style="font-size:13px;">Select a lead to see AI analysis</div></div></div>`;
  showToast('üóëÔ∏è Lead deleted');
}

// ===== PIPELINE =====
function renderPipeline() {
  const stages = ['new','contacted','qualified','converted','lost'];
  const board = document.getElementById('pipeline-board');
  board.innerHTML = stages.map(s => {
    const items = leads.filter(l => l.stage === s);
    return `
      <div class="pipeline-col">
        <div class="pipeline-col-header ${s}">${s.toUpperCase()} (${items.length})</div>
        <div class="pipeline-items">
          ${items.length === 0 ? '<div style="font-size:12px;color:var(--muted);padding:10px;text-align:center;">Empty</div>' :
            items.map(l => `
              <div class="pipeline-item" onclick="showPage('leads'); selectLead(${l.id});">
                <div class="pipeline-item-name">${l.name}</div>
                <div class="pipeline-item-meta">üìç ${l.city} ¬∑ Score: ${l.score}</div>
              </div>
            `).join('')}
        </div>
      </div>`;
  }).join('');
}

// ===== FOLLOWUPS =====
function renderFollowups() {
  const items = leads.filter(l => l.followupDate).sort((a,b) => new Date(a.followupDate) - new Date(b.followupDate));
  const list = document.getElementById('followup-list');
  if (items.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üìÖ</div><div class="empty-text">No follow-ups scheduled yet.</div></div>`;
    return;
  }
  list.innerHTML = items.map(l => {
    const d = new Date(l.followupDate);
    const isOverdue = d < new Date();
    return `
      <div class="followup-item" style="${isOverdue ? 'border-color:var(--danger)' : ''}">
        <div class="followup-date">
          <div class="day">${d.getDate()}</div>
          <div class="month">${d.toLocaleString('en-AU',{month:'short'})}</div>
        </div>
        <div class="followup-info">
          <div class="followup-name">${l.name}</div>
          <div class="followup-note">${l.city} ¬∑ ${l.service} ${isOverdue ? '‚Äî <span style="color:var(--danger)">OVERDUE</span>' : ''}</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="showPage('leads'); selectLead(${l.id});">View</button>
      </div>`;
  }).join('');
}

// ===== AI OUTREACH =====
async function generateOutreach() {
  const biz = document.getElementById('out-biz').value.trim();
  const loc = document.getElementById('out-loc').value.trim() || 'Australia';
  const service = document.getElementById('out-service').value;
  const type = document.getElementById('out-type').value;
  const notes = document.getElementById('out-notes').value.trim();

  if (!biz) { showToast('‚ö†Ô∏è Enter a business name first'); return; }

  document.getElementById('out-loading').style.display = 'block';
  document.getElementById('pitch-output').style.display = 'none';

  const prompt = `You are an expert Google Ads sales consultant targeting home renovation businesses in Australia.

Write a personalized ${type} for this prospect:
- Business: ${biz}
- Location: ${loc}
- Service: ${service}
- Notes: ${notes || 'No extra info'}

The message should:
1. Be highly personalized and specific to their business
2. Mention the specific pain of NOT running Google Ads (or running them poorly)
3. Use Australian English tone ‚Äî professional but direct
4. Reference the high value of renovation leads in Australia (avg job $20k‚Äì$60k AUD)
5. Have a clear, low-commitment CTA (e.g. "quick 15-min call")
6. NOT be generic. Sound like it was written specifically for them.
7. Keep it concise: under 200 words for email, under 100 for SMS/DM.

Write ONLY the message ‚Äî no explanation or preamble.`;

  try {
    if (!ANTHROPIC_API_KEY) { showToast('‚ö†Ô∏è API key ‡¶®‡ßá‡¶á! ‡¶â‡¶™‡¶∞‡ßá ‚öôÔ∏è ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡ßã'); document.getElementById('out-loading').style.display='none'; return; }
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-api-key": ANTHROPIC_API_KEY, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await response.json();
    const text = data.content?.map(c => c.text || '').join('') || 'Error generating message.';

    document.getElementById('out-loading').style.display = 'none';
    const out = document.getElementById('pitch-output');
    out.style.display = 'block';
    out.textContent = '';

    // Typewriter effect
    let i = 0;
    out.classList.add('typing-cursor');
    const interval = setInterval(() => {
      out.textContent = text.slice(0, i++);
      if (i > text.length) {
        clearInterval(interval);
        out.classList.remove('typing-cursor');
      }
    }, 12);

  } catch(e) {
    document.getElementById('out-loading').style.display = 'none';
    document.getElementById('pitch-output').style.display = 'block';
    document.getElementById('pitch-output').textContent = '‚ö†Ô∏è Error connecting to AI. Please try again.';
  }
}

function copyOutreach() {
  const text = document.getElementById('pitch-output').textContent;
  if (!text) { showToast('‚ö†Ô∏è Generate a pitch first'); return; }
  navigator.clipboard.writeText(text).then(() => showToast('üìã Copied to clipboard!'));
}

function quickOutreach(id) {
  const l = leads.find(x => x.id === id);
  if (!l) return;
  document.getElementById('out-biz').value = l.name;
  document.getElementById('out-loc').value = l.city;
  document.getElementById('out-notes').value = `Ads: ${l.ads}. ${l.notes}`;
  showPage('outreach');
  document.getElementById('nav-outreach').classList.add('active');
}

// ===== STATS =====
function updateStats() {
  document.getElementById('stat-total').textContent = leads.length;
  document.getElementById('stat-contacted').textContent = leads.filter(l => l.stage === 'contacted').length;
  document.getElementById('stat-qualified').textContent = leads.filter(l => l.stage === 'qualified').length;
  const converted = leads.filter(l => l.stage === 'converted').length;
  document.getElementById('stat-converted').textContent = converted;
  document.getElementById('stat-rate').textContent = leads.length ? Math.round(converted / leads.length * 100) + '%' : '0%';
  document.getElementById('badge-new').textContent = leads.filter(l => l.stage === 'new').length;
  document.getElementById('badge-followup').textContent = leads.filter(l => l.followupDate && new Date(l.followupDate) < new Date(Date.now() + 86400000 * 2)).length;
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== SAVE =====
function save() {
  localStorage.setItem('adhunter_leads', JSON.stringify(leads));
}

// ===== INIT =====
renderLeads();
updateStats();
updateApiStatus();

// Demo data if empty
if (leads.length === 0) {
  const demo = [
    { id: 1, name: "Sydney Kitchen Makeovers", owner: "David Chen", city: "Parramatta, NSW", phone: "+61 412 345 678", email: "david@sydneykitchens.com.au", website: "sydneykitchens.com.au", service: "Kitchen Renovation", ads: "no", notes: "4.9 stars on Google, busy shop, no paid ads visible", stage: "new", score: 88, addedAt: new Date().toISOString(), followupDate: null, history: ["Lead added"] },
    { id: 2, name: "Melbourne Home Extensions", owner: "Sarah Walsh", city: "Richmond, VIC", phone: "+61 401 999 100", email: "info@melbextensions.com.au", website: "melbextensions.com.au", service: "Home Extension", ads: "yes-poor", notes: "Running ads but low quality score, not showing for main keywords", stage: "contacted", score: 72, addedAt: new Date(Date.now()-86400000).toISOString(), followupDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], history: ["Lead added","Stage ‚Üí contacted"] },
    { id: 3, name: "Brisbane Bathroom Renos", owner: "Mark Thompson", city: "Fortitude Valley, QLD", phone: "+61 433 111 222", email: "mark@brisbanerenos.com.au", website: "", service: "Bathroom Remodel", ads: "no", notes: "No website found, only Facebook page. Growing fast based on reviews.", stage: "qualified", score: 91, addedAt: new Date(Date.now()-172800000).toISOString(), followupDate: null, history: ["Lead added","Stage ‚Üí qualified"] },
  ];
  leads = demo;
  save();
  renderLeads();
  updateStats();
}
</script>
</body>
</html>
